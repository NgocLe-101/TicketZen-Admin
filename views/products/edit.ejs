<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Product</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("product-form");
      const title = document.getElementById("title");
      const price = document.getElementById("price");
      const description = document.getElementById("description");
      const fileInput = document.getElementById("new-images");
      const status = document.getElementById("status");
      const deleteButtons = document.querySelectorAll(".delete-photo");

      // Validate input on form submit
      form.addEventListener("submit", (event) => {
        let errors = [];

        // Validate title
        if (title.value.trim().length === 0) {
          errors.push("Title is required.");
        }

        // Validate price
        if (!price.value || parseFloat(price.value) <= 0) {
          errors.push("Price must be a positive number.");
        }

        // Validate description
        if (description.value.trim().length < 10) {
          errors.push("Description must be at least 10 characters.");
        }

        // Validate new images
        if (fileInput.files.length > 0 && fileInput.files.length > 5) {
          errors.push("You can upload up to 5 images.");
        }

        // Validate status
        if (!["available", "suspend"].includes(status.value)) {
          errors.push("Invalid status selected.");
        }

        // Show errors or submit form
        if (errors.length > 0) {
          event.preventDefault();
          showModal("Error", errors.join("<br>"));
        }
      });

      // Remove photo logic
      deleteButtons.forEach((button) => {
        button.addEventListener("click", async (event) => {
          event.preventDefault();
          const photoId = event.target.dataset.id;
          const productId = event.target.dataset.productId;
          try {
              const response = await axios.post('/products/remove-image', { photoId, productId: productId }, {
                headers: {
                  'Content-Type': 'application/json'
                }
              });
                if (response.data.success) {
                    event.target.closest('.photo-item').remove();
                } else {
                    showModal('Error', response.data.message);
                }
          } catch (error) {
              showModal('Error', error.response.data.message);
          }
        });
      });
    });
  </script>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-6">Update Product</h1>
    <%- include('../partials/modal') %>
    <!-- Error Messages -->

    <form
      id="product-form"
      action="/products/<%= product.id %>"
      method="POST"
      enctype="multipart/form-data"
      class="bg-white shadow-lg rounded-lg p-6"
    >
      <!-- Title -->
      <div class="mb-4">
        <label for="title" class="block text-gray-700">Title</label>
        <input
          type="text"
          id="title"
          name="title"
          value="<%= product.title %>"
          class="border rounded w-full px-3 py-2"
          required
        />
      </div>

      <!-- Category -->
      <div class="mb-4">
        <label for="genre" class="block text-gray-700">Genre</label>
        <select id="genre" name="genre" class="border rounded w-full px-3 py-2" required>
          <% genres.forEach(genre => { %>
            <option value="<%= genre.id %>" <%= genre.name == product.genre ? 'selected' : '' %>>
              <%= genre.name %>
            </option>
          <% }); %>
        </select>
      </div>

      <!-- Manufacturer -->
      <div class="mb-4">
        <label for="manufacturer" class="block text-gray-700">Manufacturer</label>
        <select id="manufacturer" name="manufacturer" class="border rounded w-full px-3 py-2" required>
          <% manufacturers.forEach(manufacturer => { %>
            <option value="<%= manufacturer.id %>" <%= manufacturer.name == product.manufacturer ? 'selected' : '' %>>
              <%= manufacturer.name %>
            </option>
          <% }); %>
        </select>
      </div>

      <!-- Price -->
      <div class="mb-4">
        <label for="price" class="block text-gray-700">Price</label>
        <input
          type="number"
          id="price"
          name="price"
          min="1000"
          value="<%= product.price %>"
          class="border rounded w-full px-3 py-2"
          step="1000"
          required
        />
      </div>

      <!-- Description -->
      <div class="mb-4">
        <label for="description" class="block text-gray-700">Description</label>
        <textarea
          id="description"
          name="description"
          class="border rounded w-full px-3 py-2"
          rows="5"
          required
        ><%= product.description %></textarea>
      </div>

      <!-- Status -->
      <div class="mb-4">
        <label for="status" class="block text-gray-700">Status</label>
        <select id="status" name="status" class="border rounded w-full px-3 py-2" required>
          <option value="available" <%= product.status === 'available' ? 'selected' : '' %>>Available</option>
          <option value="suspend" <%= product.status === 'suspend' ? 'selected' : '' %>>Suspend</option>
        </select>
      </div>

      <!-- Existing Photos -->
      <div class="mb-4">
        <label class="block text-gray-700">Existing Photos</label>
        <div class="grid grid-cols-3 gap-4">
          <% product.images.forEach((image) => { %>
            <div class="photo-item">
              <img src="<%= image.image_url %>" class="w-full h-32 object-cover rounded mb-2">
              <button
                class="delete-photo bg-red-500 text-white px-2 py-1 rounded"
                data-id="<%= image.public_id %>" data-product-id="<%= product.id %>"
              >
                Remove
              </button>
            </div>
          <% }); %>
        </div>
      </div>

      <!-- Upload New Photos -->
      <div class="mb-4">
        <label for="new-images" class="block text-gray-700">Upload New Photos</label>
        <input
          type="file"
          id="new-images"
          name="newImages"
          class="border rounded w-full px-3 py-2"
          multiple
          accept="image/*"
        />
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        class="bg-blue-500 text-white px-4 py-2 rounded-lg"
      >
        Update Product
      </button>
    </form>
  </div>
</body>
</html>
